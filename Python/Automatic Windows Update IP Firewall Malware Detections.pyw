import requests, csv, subprocess

response = requests.get("https://feodotracker.abuse.ch/downloads/ipblocklist.csv").text

rule = "netsh advfirewall firewall delete rule name='Malicious IPs'"
subprocess.Popen(["Powershell", "-Command", rule], creationflags=subprocess.CREATE_NO_WINDOW)

ips = []
mycsv = csv.reader(filter(lambda x: not x.startswith("#"), response.splitlines()))
for row in mycsv:
    ip = row[1]
    if ip != "dst_ip":
        ips.append(ip)

ip_str = ",".join(ips)
print("Added Rule to block IPs")

rule = f"netsh advfirewall firewall add rule name='Malicious IPs' Dir=Out Action=Block RemoteIp={ip_str}"
subprocess.Popen(["Powershell", "-Command", rule], creationflags=subprocess.CREATE_NO_WINDOW)

rule = f"netsh advfirewall firewall add rule name='Malicious IPs' Dir=In Action=Block RemoteIp={ip_str}"
subprocess.Popen(["Powershell", "-Command", rule], creationflags=subprocess.CREATE_NO_WINDOW)
